<html>
<head>
    <title>Company Form</title>
</head>

<body>
    <!-- Dropzone for image upload -->
    <div id="dropzone" onclick="document.getElementById('companyLogo').click()" ondrop="drop(event)"
        ondragover="allowDrop(event)">
        <img id="logoPreview" src="./images/draganddrop.webp" alt="" width="100%" height="100%">
    </div>

    <!-- Hidden file input -->
    <input type="file" class="form-control d-none" id="companyLogo" accept="image/*" multiple
        onchange="uploadImage(event)">

    <!-- Company Form -->
    <form id="companyForm">
        <input type="text" id="companyName" placeholder="Company Name" required>
        <input type="text" id="technologies" placeholder="Technologies" required>
        <button type="submit" id="addCompanyBtn">Add Company</button>
        <button type="button" id="updateCompanyBtn" style="display:none;">Update Company</button>
    </form>

    <!-- Company List -->
    <div id="companyList" class="row"></div>

    <script>
        let companies = [];
        let selectedCompanyIndex = null;
        let clickCount = 0;  // For tracking triple click

        // Function to render the list of companies
        function renderCompanyList() {
            const companyList = document.getElementById('companyList');
            companyList.innerHTML = ''; // Clear the existing list

            companies.forEach((company, index) => {
                const companyElement = document.createElement('div');
                companyElement.classList.add('col-md-3', 'position-relative'); // Each company takes 1/4 of a row

                companyElement.innerHTML = `
                    <div class="company">
                        <div class="company-content">
                            <img src="${company.logo}" alt="Logo of ${company.name}" onerror="this.onerror=null; this.src='default-image.png';">
                            <p class="title">${company.name}</p>
                        </div>
                        <div class="technologies">
                            <p><strong>Technologies:</strong> ${company.technologies}</p>
                        </div>
                        <button class="btn btn-danger delete-btn" onclick="deleteCompany(${index})">X</button>
                    </div>
                `;
                companyList.appendChild(companyElement);

                // Add triple-click event to allow editing the company
                companyElement.addEventListener('click', () => handleTripleClick(company, index));
            });
        }

        // Function to handle image upload and get a data URL
        function uploadImage(event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const logoPreview = document.getElementById('logoPreview');
                logoPreview.src = e.target.result; // Set the logo preview to the data URL
            };

            if (file) {
                reader.readAsDataURL(file); // Read file as data URL
            }
        }

        // Function to populate the form fields for editing
        function populateFormFields(company, index) {
            document.getElementById('companyName').value = company.name;
            document.getElementById('technologies').value = company.technologies;

            selectedCompanyIndex = index; // Track the index of the company being edited

            // Populate logo preview
            const logoPreview = document.getElementById('logoPreview');
            
            // Check if the company has a logo
            if (company.logo) {
                logoPreview.src = company.logo; // Show the existing logo
            } else {
                logoPreview.src = './images/draganddrop.webp'; // Default if no logo
            }

            // Show update button, hide add button
            document.getElementById('addCompanyBtn').style.display = 'none';
            document.getElementById('updateCompanyBtn').style.display = 'block';
        }

        // Function to handle form submission for adding/updating companies
        function handleFormSubmit(event) {
            event.preventDefault(); // Prevent form submission

            const name = document.getElementById('companyName').value;
            const technologies = document.getElementById('technologies').value;

            // Check if a new logo has been uploaded
            const logoPreview = document.getElementById('logoPreview');
            const logo = logoPreview.src; // Use the data URL from the preview as the logo

            if (selectedCompanyIndex !== null) {
                // Edit existing company
                companies[selectedCompanyIndex] = { name, logo, technologies };
                selectedCompanyIndex = null;
            } else {
                // Add new company
                companies.push({ name, logo, technologies });
            }

            document.getElementById('companyForm').reset(); // Clear the form
            logoPreview.src = './images/draganddrop.webp'; // Reset logo preview

            // Switch buttons back to "Add Company"
            document.getElementById('addCompanyBtn').style.display = 'block';
            document.getElementById('updateCompanyBtn').style.display = 'none';

            renderCompanyList(); // Re-render the company list
        }

        // Function to handle updating company
        function handleCompanyUpdate() {
            const name = document.getElementById('companyName').value;
            const technologies = document.getElementById('technologies').value;
            const logoPreview = document.getElementById('logoPreview');

            const logo = logoPreview.src; // Use the data URL from the preview as the logo

            if (!name || !technologies) {
                alert("Please fill in all fields.");
                return;
            }

            // Update company details
            companies[selectedCompanyIndex] = { name, logo, technologies };

            // Reset form and buttons
            document.getElementById('companyForm').reset();
            logoPreview.src = './images/draganddrop.webp'; // Reset logo preview
            document.getElementById('addCompanyBtn').style.display = 'block';
            document.getElementById('updateCompanyBtn').style.display = 'none';

            selectedCompanyIndex = null;
            renderCompanyList(); // Re-render the company list
        }

        // Function to handle triple click to populate form fields
        function handleTripleClick(company, index) {
            clickCount++;  // Increment click count

            if (clickCount === 3) {
                populateFormFields(company, index);  // Populate the form for editing
                clickCount = 0;  // Reset click count
            }

            // Reset click count after some delay to detect triple click
            setTimeout(() => { clickCount = 0; }, 500);
        }

        // Function to delete a company
        function deleteCompany(index) {
            companies.splice(index, 1); // Remove the company from the array
            renderCompanyList(); // Re-render the company list
        }

        // Event listeners for form submission and company update
        document.getElementById('companyForm').addEventListener('submit', handleFormSubmit);
        document.getElementById('updateCompanyBtn').addEventListener('click', handleCompanyUpdate);

        // Initial render of company list
        renderCompanyList();
    </script>
</body>
</html>
